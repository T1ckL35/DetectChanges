name: matrix tests
on:
  push:
  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Log level'
        required: true
        default: 'warning'
        type: choice
        options:
        - info
        - warning
        - debug
      # tags:
      #   description: 'Test scenario tags'
      #   required: false
      #   type: boolean
      # environment:
      #   description: 'Environment to run tests against'
      #   type: environment
      #   required: true

jobs:
  # test_file:
  #   runs-on: ubuntu-latest
  #   steps:
  #   # works here without codebase checkout?
  #   - run: mkdir -p reports/test
  #   - run: echo hello > reports/test/world.txt
  #   - uses: actions/upload-artifact@v4
  #     with:
  #       name: my-artifact
  #       path: reports/test/world.txt

  run-tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        shardIndex: [1, 2, 3, 4]
    steps:
      # Needs to checkout the codebase for the artifact upload to work here. Strange
      - uses: actions/checkout@v4
      #- run: mkdir -p reports
      - name: Upload blob report to GitHub Actions Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: report-${{ matrix.shardIndex }}
          path: reports/
          retention-days: 1

  merge-reports:
    # Merge reports after run-tests, even if some shards have failed
    #if: always()
    needs: [run-tests]
    runs-on: ubuntu-latest
    steps:
      # Needs to checkout the codebase for the artifact downoad to work here. Strange
      - uses: actions/checkout@v4
      - name: Download blob reports from GitHub Actions Artifacts
        uses: actions/download-artifact@v4
        with:
          path: reports/
          pattern: report-*
          merge-multiple: true
      - run: ls reports/report-*
      - run: cat reports/report-*

          
      # # https://github.com/actions/runner/pull/2477
      # # parallel matrix doesn't yet support dynamic outputs
      # # hence storing individual output in text files and re-joining them later
      # - uses: actions/upload-artifact@v4
      #   with:
      #     name: analysis-${{ matrix.samples }}.txt
      #     path: .github/scripts/analysis-${{ matrix.samples }}.txt
